<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Statzy - Live Prognos</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #00d1ff; --text: #eee; --win: #4cd964; --error: #ff3b30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Setup Screen */
        #setup { text-align: center; padding-top: 40px; }
        .version-text { font-size: 10px; color: #555; margin-top: 5px; letter-spacing: 1px; }
        .player-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; }
        input[type="text"] { background: #333; border: 2px solid #444; color: white; padding: 12px; border-radius: 10px; width: 65%; font-size: 16px; }
        .remove-btn { background: #442222; color: #ff6666; border: none; padding: 12px 15px; border-radius: 10px; font-weight: bold; }
        .btn-main { background: var(--accent); border: none; padding: 18px 25px; border-radius: 15px; font-weight: bold; cursor: pointer; color: #000; width: 85%; max-width: 300px; box-shadow: 0 4px 15px rgba(0, 209, 255, 0.3); }

        /* Game Screen */
        header { position: sticky; top: 0; background: var(--bg); padding: 10px 0; z-index: 10; border-bottom: 1px solid #333; }
        .prob-bar { display: flex; height: 32px; background: #222; border-radius: 16px; overflow: hidden; margin: 10px 0; border: 1px solid #444; }
        .prob-seg { transition: width 0.7s cubic-bezier(0.2, 1, 0.3, 1); text-align: center; color: #000; font-size: 13px; line-height: 32px; font-weight: 800; }
        #winner-banner { display: none; background: #ffd700; color: #000; padding: 12px; text-align: center; font-weight: 900; border-radius: 10px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 20px; }
        th, td { padding: 12px 4px; border-bottom: 1px solid #222; text-align: center; }
        td:first-child { text-align: left; width: 38%; font-weight: bold; color: #999; padding-left: 8px; }
        
        .score-box { background: #262626; border-radius: 8px; padding: 12px 0; min-height: 22px; border: 1px solid #3a3a3a; font-weight: bold; color: var(--accent); font-size: 16px; }
        .sum-row { background: #1a1a1a; color: #fff; }
        .total-row { background: #000; border-top: 2px solid var(--accent); color: var(--accent); font-size: 1.2em; }

        /* MODAL & CUSTOM KEYPADS */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 90; backdrop-filter: blur(8px); }
        #modal { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #1e1e1e; z-index: 100; border-radius: 30px 30px 0 0; padding: 25px 20px 50px 20px; box-sizing: border-box; }
        
        .modal-title { margin-bottom: 20px; font-weight: bold; color: var(--accent); text-align: center; font-size: 1.2em; text-transform: uppercase; }
        .quick-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .quick-btn { background: #333; padding: 20px; border-radius: 15px; text-align: center; font-weight: bold; font-size: 20px; color: white; box-shadow: 0 4px 0 #000; }
        .quick-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #000; }
        
        /* Blank/Rensa knapp */
        .blank-btn { background: #3d1a1a !important; color: #ff6b6b !important; grid-column: span 3; margin-bottom: 15px; border: 2px dashed #ff4444; font-size: 16px; }
        
        /* Snyggt Numeriskt Tangentbord */
        #num-display { background: #000; color: var(--accent); font-size: 42px; text-align: center; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--accent); font-family: 'Courier New', monospace; font-weight: bold; }
        .num-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .ok-btn { background: var(--win) !important; color: #000 !important; grid-column: span 2; font-size: 22px; }
        .clear-digit { background: #444 !important; }

        .game-footer { padding: 30px 20px; text-align: center; }
        .btn-outline { background: none; border: 1px solid #444; color: #777; padding: 12px 20px; border-radius: 12px; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

<div id="setup">
    <h1 style="font-size: 4em; margin-bottom: 0; color: var(--accent); letter-spacing: -2px;">Statzy</h1>
    <div class="version-text">VERSION 1.5.0 PRO</div>
    <br><br>
    <div id="player-list">
        </div>
    <button class="btn-outline" style="color: var(--accent); border-color: var(--accent);" onclick="addPlayerField('')">+ L칛gg till spelare</button>
    <br><br><br>
    <button class="btn-main" onclick="startGame()">STARTA MATCH</button>
</div>

<div id="game" style="display:none;">
    <header>
        <div id="winner-banner">游끥 <span id="winner-name"></span> HAR VUNNIT! 游끥</div>
        <div class="prob-bar" id="probBar"></div>
    </header>
    
    <table id="scoreTable"></table>

    <div class="game-footer">
        <button class="btn-main" onclick="nextRound()">N츿STA RUNDA</button>
        <br>
        <button class="btn-outline" onclick="if(confirm('Vill du avsluta helt?')) resetEverything()">Nollst칛ll allt</button>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div id="modal">
    <div class="modal-title" id="modalTitle">Kategori</div>
    
    <div id="quick-pick-section">
        <div class="quick-btn blank-btn" onclick="setScoreAndClose(null)">[ ] BLANK / RENSA RUTA</div>
        <div class="quick-grid" id="quickGrid"></div>
    </div>

    <div id="numeric-section" style="display:none;">
        <div class="quick-btn blank-btn" onclick="setScoreAndClose(null)">[ ] BLANK / RENSA RUTA</div>
        <div id="num-display">-</div>
        <div class="num-grid">
            <div class="quick-btn" onclick="pressNum(1)">1</div><div class="quick-btn" onclick="pressNum(2)">2</div><div class="quick-btn" onclick="pressNum(3)">3</div>
            <div class="quick-btn" onclick="pressNum(4)">4</div><div class="quick-btn" onclick="pressNum(5)">5</div><div class="quick-btn" onclick="pressNum(6)">6</div>
            <div class="quick-btn" onclick="pressNum(7)">7</div><div class="quick-btn" onclick="pressNum(8)">8</div><div class="quick-btn" onclick="pressNum(9)">9</div>
            <div class="quick-btn clear-digit" onclick="pressNum('C')">C</div><div class="quick-btn" onclick="pressNum(0)">0</div>
            <div class="quick-btn ok-btn" onclick="confirmNumeric()">KLAR</div>
        </div>
    </div>
</div>

<script>
let players = [];
let activePIdx = null, activeCat = null, currentNumInput = "";
const upperCats = ["Ettor", "Tv친or", "Treor", "Fyror", "Femmor", "Sexor"];
const lowerCats = ["Ett par", "Tv친 par", "Triss", "Fyrtal", "Liten stege", "Stor stege", "K친k", "Chans", "Yatzy"];
const colors = ["#4cd964", "#00d1ff", "#ffcc00", "#ff3b30", "#af52de", "#ff9500"];

// Ladda vid start
window.onload = () => {
    const savedNames = localStorage.getItem('statzy_names');
    const savedScores = localStorage.getItem('statzy_scores');
    
    if (savedNames) {
        const names = JSON.parse(savedNames);
        names.forEach(n => addPlayerField(n));
        
        if (savedScores) {
            players = JSON.parse(savedScores);
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            renderBoard();
        }
    } else {
        addPlayerField('Spelare 1');
        addPlayerField('Spelare 2');
    }
};

function addPlayerField(name) {
    const div = document.createElement('div');
    div.className = 'player-row';
    div.innerHTML = `
        <input type="text" placeholder="Namn" value="${name}">
        <button class="remove-btn" onclick="this.parentElement.remove()">TA BORT</button>
    `;
    document.getElementById('player-list').appendChild(div);
}

function startGame() {
    const inputs = document.querySelectorAll('#player-list input');
    const names = Array.from(inputs).map(i => i.value || 'Spelare');
    
    players = names.map((name, i) => ({
        name: name,
        scores: {},
        color: colors[i % colors.length]
    }));
    
    localStorage.setItem('statzy_names', JSON.stringify(names));
    saveScores();
    
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    renderBoard();
}

function nextRound() {
    if(confirm("Vill du starta en ny runda? Du kommer tillbaka till namnvalet.")) {
        // Beh친ll namnen men nolla scores
        players.forEach(p => p.scores = {});
        localStorage.removeItem('statzy_scores');
        
        // Uppdatera setup-listan s친 namnen st칛mmer
        const list = document.getElementById('player-list');
        list.innerHTML = "";
        players.forEach(p => addPlayerField(p.name));
        
        document.getElementById('game').style.display = 'none';
        document.getElementById('setup').style.display = 'block';
        window.scrollTo(0,0);
    }
}

function resetEverything() { localStorage.clear(); location.reload(); }
function saveScores() { localStorage.setItem('statzy_scores', JSON.stringify(players)); }

function calculateValues(pIdx) {
    let sum = 0;
    upperCats.forEach(cat => sum += (players[pIdx].scores[cat] || 0));
    const bonus = sum >= 63 ? 50 : 0;
    let total = sum + bonus;
    lowerCats.forEach(cat => total += (players[pIdx].scores[cat] || 0));
    return { sum, bonus, total };
}

function renderBoard() {
    let html = `<thead><tr><th>Kategori</th>${players.map(p => `<th style="color:${p.color}">${p.name}</th>`).join('')}</tr></thead><tbody>`;
    upperCats.forEach(cat => html += renderRow(cat));
    html += renderStaticRow("Summa", "sum", "sum-row");
    html += renderStaticRow("Bonus (50p)", "bonus", "sum-row");
    lowerCats.forEach(cat => html += renderRow(cat));
    html += renderStaticRow("TOTALT", "total", "total-row");
    document.getElementById('scoreTable').innerHTML = html;
    updatePrognosis();
}

function renderRow(cat) {
    return `<tr><td>${cat}</td>${players.map((p, i) => {
        let display = p.scores[cat] === undefined ? "" : (p.scores[cat] === 0 ? "/" : p.scores[cat]);
        return `<td><div class="score-box" onclick="openInput(${i}, '${cat}')">${display}</div></td>`;
    }).join('')}</tr>`;
}

function renderStaticRow(label, type, className) {
    return `<tr class="${className}"><td>${label}</td>${players.map((p, i) => `<td>${calculateValues(i)[type]}</td>`).join('')}</tr>`;
}

function openInput(pIdx, cat) {
    activePIdx = pIdx; activeCat = cat;
    const isNumeric = ["Tv친 par", "K친k", "Chans"].includes(cat);
    document.getElementById('modalTitle').innerText = `${players[pIdx].name}: ${cat}`;
    document.getElementById('quick-pick-section').style.display = isNumeric ? 'none' : 'block';
    document.getElementById('numeric-section').style.display = isNumeric ? 'block' : 'none';
    
    if (!isNumeric) {
        const grid = document.getElementById('quickGrid'); grid.innerHTML = "";
        let opts = [0];
        if (upperCats.includes(cat)) { 
            const v = upperCats.indexOf(cat)+1; for(let j=1;j<=6;j++) opts.push(v*j);
        } else if (cat.includes("par")) [2,4,6,8,10,12,14,16,18,20,22,24].filter(v => v <= 12 || cat === "Tv친 par").forEach(v => { if(!opts.includes(v)) opts.push(v); });
        else if (cat === "Triss") [3,6,9,12,15,18].forEach(v => opts.push(v));
        else if (cat === "Fyrtal") [4,8,12,16,20,24].forEach(v => opts.push(v));
        else if (cat === "Liten stege") opts.push(15);
        else if (cat === "Stor stege") opts.push(20);
        else if (cat === "Yatzy") opts.push(50);

        opts.sort((a,b)=>a-b).forEach(o => {
            const b = document.createElement('div'); b.className = 'quick-btn';
            b.innerText = o === 0 ? "/" : o; b.onclick = () => setScoreAndClose(o);
            grid.appendChild(b);
        });
    } else {
        currentNumInput = ""; document.getElementById('num-display').innerText = "-";
    }
    document.getElementById('modal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}

function pressNum(v) {
    if (v === 'C') currentNumInput = "";
    else if (currentNumInput.length < 2) currentNumInput += v;
    document.getElementById('num-display').innerText = currentNumInput || "-";
}

function confirmNumeric() { if (currentNumInput !== "") setScoreAndClose(parseInt(currentNumInput)); }

function setScoreAndClose(v) {
    if (v === null) delete players[activePIdx].scores[activeCat];
    else players[activePIdx].scores[activeCat] = v;
    saveScores(); closeModal(); renderBoard();
}

function closeModal() {
    document.getElementById('modal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
}

function updatePrognosis() {
    const iter = 3000;
    let wins = new Array(players.length).fill(0);
    for (let i = 0; i < iter; i++) {
        let simScores = players.map(p => {
            let s = 0, uSum = 0;
            upperCats.forEach(c => { let v = p.scores[c] !== undefined ? p.scores[c] : simulate(c); uSum += v; s += v; });
            if (uSum >= 63) s += 50;
            lowerCats.forEach(c => s += (p.scores[c] !== undefined ? p.scores[c] : simulate(c)));
            return s;
        });
        wins[simScores.indexOf(Math.max(...simScores))]++;
    }
    const bar = document.getElementById('probBar'); bar.innerHTML = "";
    let winnerFound = false;
    players.forEach((p, i) => {
        const pct = (wins[i] / iter) * 100;
        if (pct === 100) { winnerFound = true; document.getElementById('winner-name').innerText = p.name; }
        const div = document.createElement('div'); div.className = "prob-seg";
        div.style.width = pct + "%"; div.style.backgroundColor = p.color;
        div.innerText = pct > 12 ? Math.round(pct) + "%" : "";
        bar.appendChild(div);
    });
    document.getElementById('winner-banner').style.display = winnerFound ? 'block' : 'none';
}

function simulate(cat) {
    const r = Math.random();
    if (upperCats.includes(cat)) return r > 0.4 ? (upperCats.indexOf(cat) + 1) * 3 : 0;
    if (cat === "Yatzy") return r < 0.04 ? 50 : 0;
    if (cat === "Liten stege") return r < 0.25 ? 15 : 0;
    if (cat === "Stor stege") return r < 0.15 ? 20 : 0;
    return Math.floor(r * 12) + 8;
}
</script>
</body>
</html>
