<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Statzy - Strategic AI</title>
    <style>
        :root { 
            --bg: #0d0d0d; --card: #1c1c1e; --accent: #00d1ff; --text: #f2f2f7; --win: #34c759; --error: #ff3b30;
            --padd: 8px; --fs-base: 14px; --sb-h: 20px; --row-h: 34px; --prob-h: 22px;
        }

        body.zoom-normal { --padd: 8px; --fs-base: 14px; --sb-h: 20px; --row-h: 34px; --prob-h: 22px; }
        body.zoom-compact { --padd: 2px; --fs-base: 12px; --sb-h: 18px; --row-h: 24px; --prob-h: 18px; }
        body.zoom-tiny { --padd: 0px; --fs-base: 10px; --sb-h: 14px; --row-h: 18px; --prob-h: 14px; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 2px 2px 2px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; font-size: var(--fs-base); }
        
        #setup { text-align: center; padding-top: 30px; }
        .player-row { display: flex; align-items: center; justify-content: center; gap: 5px; margin: 10px 0; }
        input[type="text"] { background: #1c1c1e; border: 2px solid #333; color: white; padding: 12px; border-radius: 10px; width: 65%; font-size: 16px; outline: none; }
        .remove-btn { background: #451010; color: #ff3b30; border: 1px solid #631414; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 11px; }
        .btn-main { background: var(--accent); border: none; padding: 18px 30px; border-radius: 16px; font-weight: 800; cursor: pointer; color: #000; width: 85%; max-width: 320px; font-size: 1.1em; }

        header { position: sticky; top: 0; background: var(--bg); padding: 4px 5px; z-index: 10; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #222; }
        .prob-bar { flex-grow: 1; display: flex; height: var(--prob-h); background: #111; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
        .prob-seg { transition: width 0.7s cubic-bezier(0.2, 1, 0.3, 1); text-align: center; color: #000; font-size: 11px; line-height: var(--prob-h); font-weight: 900; }
        .settings-trigger { background: #222; border: none; color: #aaa; padding: 5px 8px; border-radius: 6px; font-size: 16px; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        td { padding: var(--padd) 1px; border-bottom: 1px solid #222; text-align: center; height: var(--row-h); position: relative; }
        
        /* Notch-fix i liggande l칛ge */
        td:first-child { text-align: left; width: 35%; font-weight: 700; color: #999; padding-left: 10px; border-right: 1px solid #222; }
        body.mode-tv td:first-child { padding-left: calc(env(safe-area-inset-left) + 20px); }

        .score-box { background: #1a1a1c; border-radius: 4px; min-height: var(--sb-h); border: 1px solid #333; font-weight: 800; color: var(--accent); font-size: calc(var(--fs-base) + 1px); line-height: var(--sb-h); display: flex; align-items: center; justify-content: center; }
        .last-changed-box { border: 2px solid #fff !important; box-shadow: 0 0 10px rgba(255,255,255,0.4); z-index: 2; animation: pulseBorder 2s infinite; }
        @keyframes pulseBorder { 50% { border-color: rgba(255,255,255,1); box-shadow: 0 0 15px rgba(255,255,255,0.6); } }

        .sum-row { background: #111; color: #fff; font-size: 0.85em; }
        .total-row { background: #000; border-top: 2px solid var(--accent); color: var(--accent); font-weight: 900; }

        body.mode-tv #score-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* Modals */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.94); z-index: 90; backdrop-filter: blur(8px); }
        .modal { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #1c1c1e; z-index: 100; border-radius: 20px 20px 0 0; padding: 15px; box-sizing: border-box; border-top: 1px solid #333; }
        
        .modal-cat-name { font-size: 1.2em; font-weight: 900; color: var(--accent); text-transform: uppercase; text-align: center; }
        .modal-player-name { font-size: 0.9em; color: #888; text-align: center; margin-bottom: 10px; }

        .quick-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .quick-btn { background: #2c2c2e; padding: 12px; border-radius: 10px; text-align: center; font-weight: 800; font-size: 18px; color: white; border: 1px solid #3a3a3c; }
        .quick-btn.active-zoom { border-color: var(--accent); }
        .quick-btn.already-selected { background: var(--accent); color: #000; }
        
        /* D칬d knapp f칬r siffra 4 */
        .btn-dead { opacity: 0.15; pointer-events: none; filter: grayscale(1); }

        #num-display { background: #000; color: var(--accent); font-size: 32px; text-align: center; padding: 5px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #333; min-height: 40px; }
        
        /* Anpassning f칬r liggande tangentbord */
        @media (orientation: landscape) {
            .num-grid { grid-template-columns: repeat(6, 1fr); }
            .modal { padding: 10px; }
        }

        .settings-section { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .switch { width: 44px; height: 24px; background: #333; border-radius: 12px; position: relative; cursor: pointer; }
        .switch.on { background: var(--win); }
        .switch::after { content: ''; width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.2s; }
        .switch.on::after { left: 22px; }
        
        .game-footer { padding: 10px; text-align: center; display: none; }
        .btn-round { background: var(--accent); border: none; padding: 12px 30px; border-radius: 12px; font-weight: 800; color: #000; }
    </style>
</head>
<body class="zoom-compact">

<div id="setup">
    <h1 style="font-size: 4em; margin: 0; color: var(--accent); letter-spacing: -3px; font-weight: 900;">Statzy</h1>
    <div id="player-list"></div>
    <button style="background:none; border:1px solid #333; color:#777; padding:10px; border-radius:10px; font-size:12px; margin-top:15px" onclick="addPlayerField('')">+ L츿GG TILL SPELARE</button>
    <br><br>
    <button class="btn-main" onclick="startGame()">STARTA MATCH</button>
</div>

<div id="game" style="display:none;">
    <header>
        <button class="settings-trigger" onclick="openSettings()">丘뙖잺</button>
        <div class="prob-bar" id="probBar"></div>
    </header>
    <div id="score-container">
        <table id="tableUpper"></table>
        <table id="tableLower"></table>
    </div>
    <div class="game-footer" id="mainFooter">
        <button class="btn-round" onclick="nextRound()">N츿STA RUNDA</button>
    </div>
</div>

<div class="overlay" id="overlaySettings" onclick="closeSettings()"></div>
<div class="modal" id="modalSettings">
    <div class="settings-section">
        <div class="quick-grid">
            <button class="quick-btn zoom-opt" id="opt-zoom-normal" onclick="setZoom('zoom-normal')">STD</button>
            <button class="quick-btn zoom-opt" id="opt-zoom-compact" onclick="setZoom('zoom-compact')">KOMP</button>
            <button class="quick-btn zoom-opt" id="opt-zoom-tiny" onclick="setZoom('zoom-tiny')">MINI</button>
        </div>
    </div>
    <div class="settings-section">
        <div class="toggle-row" style="display:flex; justify-content:space-between; align-items:center; margin:10px 0;">
            <span>Strategiska Tips</span>
            <div class="switch" id="toggleCritical" onclick="toggleOption('critical')"></div>
        </div>
        <div class="toggle-row" style="display:flex; justify-content:space-between; align-items:center; margin:10px 0;">
            <span>TV-L칛ge</span>
            <div class="switch" id="toggleTV" onclick="toggleOption('tv')"></div>
        </div>
        <div id="wakeIndicator" style="font-size:10px; color:var(--win);">Sk칛rml친s: AKTIVT 游릭</div>
    </div>
    <button class="btn-main" onclick="closeSettings()">KLAR</button>
</div>

<div class="overlay" id="overlayInput" onclick="closeModal()"></div>
<div class="modal" id="modalInput">
    <div id="modalInputTitle"></div>
    <div id="quick-pick-section">
        <div class="quick-grid" id="quickGrid"></div>
        <button style="background:none; color:#666; border:none; margin-top:20px; width:100%; text-decoration:underline;" onclick="setScoreAndClose(null)">Rensa</button>
    </div>
    <div id="numeric-section" style="display:none;">
        <div id="err-msg" style="color:red; text-align:center; font-size:12px; min-height:15px"></div>
        <div id="num-display">-</div>
        <div class="num-grid quick-grid">
            <div class="quick-btn" onclick="pressNum(1)">1</div><div class="quick-btn" onclick="pressNum(2)">2</div><div class="quick-btn" onclick="pressNum(3)">3</div>
            <div class="quick-btn btn-dead">4</div><div class="quick-btn" onclick="pressNum(5)">5</div><div class="quick-btn" onclick="pressNum(6)">6</div>
            <div class="quick-btn" onclick="pressNum(7)">7</div><div class="quick-btn" onclick="pressNum(8)">8</div><div class="quick-btn" onclick="pressNum(9)">9</div>
            <div class="quick-btn" style="background:#444" onclick="pressNum('C')">C</div><div class="quick-btn" onclick="pressNum(0)">0</div>
            <div class="quick-btn" style="background:var(--win); color:black" onclick="confirmNumeric()">OK</div>
        </div>
    </div>
</div>

<script>
let players = [];
let options = { critical: false, tv: false };
let activePIdx = null, activeCat = null, currentNumInput = "";
let lastChangedCell = { pIdx: null, cat: null };
let wakeLock = null;

const upperCats = ["Ettor", "Tv친or", "Treor", "Fyror", "Femmor", "Sexor"];
const lowerCats = ["Ett par", "Tv친 par", "Triss", "Fyrtal", "Liten stege", "Stor stege", "K친k", "Chans", "Yatzy"];
const colors = ["#34c759", "#00d1ff", "#ffcc00", "#ff3b30", "#af52de", "#ff9500"];

window.onload = () => {
    const savedNames = localStorage.getItem('statzy_names');
    const savedScores = localStorage.getItem('statzy_scores');
    const savedZoom = localStorage.getItem('statzy_zoom') || 'zoom-compact';
    setZoom(savedZoom);
    if (savedNames) {
        JSON.parse(savedNames).forEach(n => addPlayerField(n));
        if (savedScores) {
            players = JSON.parse(savedScores);
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            renderBoard();
        }
    } else { addPlayerField('Spelare 1'); addPlayerField('Spelare 2'); }
    updateToggles();
};

async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
        }
    } catch (err) {}
}

function setZoom(mode) {
    document.body.classList.remove('zoom-normal', 'zoom-compact', 'zoom-tiny');
    document.body.classList.add(mode);
    localStorage.setItem('statzy_zoom', mode);
    document.querySelectorAll('.zoom-opt').forEach(btn => btn.classList.remove('active-zoom'));
    const activeBtn = document.getElementById('opt-' + mode);
    if(activeBtn) activeBtn.classList.add('active-zoom');
    if(players.length > 0) renderBoard();
}

function openSettings() { document.getElementById('modalSettings').style.display = 'block'; document.getElementById('overlaySettings').style.display = 'block'; }
function closeSettings() { document.getElementById('modalSettings').style.display = 'none'; document.getElementById('overlaySettings').style.display = 'none'; }

function toggleOption(opt) {
    options[opt] = !options[opt];
    if(opt === 'tv') document.body.classList.toggle('mode-tv', options.tv);
    updateToggles();
    renderBoard();
}

function updateToggles() {
    document.getElementById('toggleCritical').className = 'switch ' + (options.critical ? 'on' : '');
    document.getElementById('toggleTV').className = 'switch ' + (options.tv ? 'on' : '');
}

function addPlayerField(name) {
    const div = document.createElement('div');
    div.className = 'player-row';
    const isDefault = name.startsWith('Spelare ');
    div.innerHTML = `<input type="text" placeholder="${isDefault ? name : 'Namn'}" value="${isDefault ? '' : name}">
        <button class="remove-btn" onclick="this.parentElement.remove()">TA BORT</button>`;
    document.getElementById('player-list').appendChild(div);
}

function startGame() {
    const inputs = document.querySelectorAll('#player-list input');
    let rawNames = Array.from(inputs).map((i, idx) => i.value || i.placeholder || `Spelare ${idx+1}`);
    let nameCounts = {};
    let uniqueNames = rawNames.map(name => {
        nameCounts[name] = (nameCounts[name] || 0) + 1;
        if (rawNames.filter(n => n === name).length > 1) return `${name} ${nameCounts[name]}`;
        return name;
    });
    players = uniqueNames.map((name, i) => ({ name: name, scores: {}, color: colors[i % colors.length] }));
    localStorage.setItem('statzy_names', JSON.stringify(uniqueNames));
    saveScores();
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    requestWakeLock();
    renderBoard();
}

function nextRound() {
    if(confirm("N칛sta runda?")) {
        players.forEach(p => p.scores = {});
        lastChangedCell = { pIdx: null, cat: null };
        localStorage.removeItem('statzy_scores');
        closeSettings();
        document.getElementById('game').style.display = 'none';
        document.getElementById('setup').style.display = 'block';
        const list = document.getElementById('player-list');
        list.innerHTML = "";
        players.forEach(p => addPlayerField(p.name));
    }
}

function saveScores() { localStorage.setItem('statzy_scores', JSON.stringify(players)); }

function getTableDisplayName(name) {
    const zoom = document.body.className;
    if (zoom === 'zoom-normal' && players.length <= 3) return name.substring(0, 6);
    return name.substring(0, 2).toUpperCase();
}

function renderBoard() {
    const renderTable = (cats, isUpper) => {
        let h = `<thead><tr><th></th>${players.map(p => `<th style="color:${p.color}">${getTableDisplayName(p.name)}</th>`).join('')}</tr></thead><tbody>`;
        cats.forEach(cat => {
            h += `<tr><td>${cat}</td>${players.map((p, i) => {
                let d = p.scores[cat] === undefined ? "" : (p.scores[cat] === 0 ? "/" : p.scores[cat]);
                const isLast = lastChangedCell.pIdx === i && lastChangedCell.cat === cat;
                return `<td class="${options.critical && p.criticalCat === cat ? 'critical-cell' : ''}"><div class="score-box ${isLast ? 'last-changed-box' : ''}" onclick="openInput(${i}, '${cat}')">${d}</div></td>`;
            }).join('')}</tr>`;
        });
        if(isUpper) {
            h += `<tr class="sum-row"><td>Summa</td>${players.map((p, i) => {
                const v = calculateValues(i);
                let diffText = v.diff === 0 ? "par" : (v.diff > 0 ? "+" + v.diff : v.diff);
                return `<td style="font-weight:bold">${v.sum} <span style="font-size:9px; opacity:0.8; color:${v.diff < 0 ? '#ff3b30' : '#34c759'}">(${diffText})</span></td>`;
            }).join('')}</tr>`;
            h += renderStaticRow("Bonus", "bonus", "sum-row");
        } else { h += renderStaticRow("TOTALT", "total", "total-row"); }
        return h + `</tbody>`;
    };
    document.getElementById('tableUpper').innerHTML = renderTable(upperCats, true);
    document.getElementById('tableLower').innerHTML = renderTable(lowerCats, false);
    checkGameStatus(); updatePrognosis();
}

function checkGameStatus() {
    const allFinished = players.every(p => Object.keys(p.scores).length === 15);
    document.getElementById('mainFooter').style.display = allFinished ? 'block' : 'none';
}

function renderStaticRow(label, type, className) {
    return `<tr class="${className}"><td>${label}</td>${players.map((p, i) => `<td style="font-weight:bold">${calculateValues(i)[type]}</td>`).join('')}</tr>`;
}

function calculateValues(pIdx) {
    let sum = 0, diff = 0;
    upperCats.forEach((cat, idx) => {
        if (players[pIdx].scores[cat] !== undefined) {
            sum += players[pIdx].scores[cat];
            diff += (players[pIdx].scores[cat] - (idx + 1) * 3);
        }
    });
    const bonus = sum >= 63 ? 50 : 0;
    const total = sum + bonus + lowerCats.reduce((a,c) => a + (players[pIdx].scores[c] || 0), 0);
    return { sum, bonus, total, diff };
}

function openInput(pIdx, cat) {
    requestWakeLock();
    activePIdx = pIdx; activeCat = cat;
    const currentScore = players[pIdx].scores[cat];
    const isNumeric = ["Tv친 par", "K친k", "Chans"].includes(cat);
    document.getElementById('modalInputTitle').innerHTML = `<div class="modal-cat-name">${cat}</div><div class="modal-player-name">${players[pIdx].name}</div>`;
    document.getElementById('modalInput').style.display = 'block';
    document.getElementById('overlayInput').style.display = 'block';
    document.getElementById('quick-pick-section').style.display = isNumeric ? 'none' : 'block';
    document.getElementById('numeric-section').style.display = isNumeric ? 'block' : 'none';
    if (!isNumeric) {
        const grid = document.getElementById('quickGrid'); grid.innerHTML = "";
        let opts = [0];
        if (upperCats.includes(cat)) { const v = upperCats.indexOf(cat)+1; for(let j=1; j<=6; j++) opts.push(v*j); }
        else if (cat === "Ett par") [2,4,6,8,10,12].forEach(v => opts.push(v));
        else if (cat === "Triss") [3,6,9,12,15,18].forEach(v => opts.push(v));
        else if (cat === "Fyrtal") [4,8,12,16,20,24].forEach(v => opts.push(v));
        else if (cat === "Liten stege") opts.push(15); else if (cat === "Stor stege") opts.push(20); else if (cat === "Yatzy") opts.push(50);
        opts.sort((a,b)=>a-b).forEach(o => {
            const b = document.createElement('div'); b.className = 'quick-btn' + (currentScore === o ? ' already-selected' : '');
            b.innerText = o === 0 ? "/" : o; b.onclick = () => setScoreAndClose(o); grid.appendChild(b);
        });
    } else { 
        currentNumInput = currentScore !== undefined ? currentScore.toString() : ""; 
        document.getElementById('num-display').innerText = currentNumInput || "-"; 
    }
}

// SPEED-INPUT LOGIK
function pressNum(v) {
    if (v === 'C') {
        currentNumInput = "";
    } else {
        if (currentNumInput.length < 2) currentNumInput += v;
    }
    document.getElementById('num-display').innerText = currentNumInput || "-";
    
    // Auto-logga om f칬rsta siffran 칛r >= 5
    const firstDigit = parseInt(currentNumInput[0]);
    if (currentNumInput.length === 1 && firstDigit >= 5) {
        confirmNumeric();
    } 
    // Auto-logga om det finns tv친 siffror och de b칬rjar p친 0,1,2,3
    else if (currentNumInput.length === 2 && [0,1,2,3].includes(firstDigit)) {
        confirmNumeric();
    }
}

function confirmNumeric() {
    const val = parseInt(currentNumInput);
    let min = 0, max = 30;
    if (activeCat === "Tv친 par") { min = 6; max = 22; }
    if (activeCat === "K친k") { min = 7; max = 28; }
    if (isNaN(val) || val < min || val > max) { 
        // Visa bara fel om det 칛r en medveten bekr칛ftelse (ej auto-log)
        document.getElementById('err-msg').innerText = `Ogiltigt!`; 
    } else { setScoreAndClose(val); }
}

function setScoreAndClose(v) {
    if (v === null) { delete players[activePIdx].scores[activeCat]; lastChangedCell = { pIdx: null, cat: null }; }
    else { players[activePIdx].scores[activeCat] = v; lastChangedCell = { pIdx: activePIdx, cat: activeCat }; }
    saveScores(); closeModal(); renderBoard();
}

function closeModal() { document.getElementById('modalInput').style.display = 'none'; document.getElementById('overlayInput').style.display = 'none'; document.getElementById('err-msg').innerText = "";}

function updatePrognosis() {
    const iter = 3000;
    let wins = new Array(players.length).fill(0);
    for (let i = 0; i < iter; i++) {
        let simScores = players.map(p => {
            let s = 0, uSum = 0;
            upperCats.forEach(c => { let v = p.scores[c] !== undefined ? p.scores[c] : simulate(c, true); uSum += v; s += v; });
            if (uSum >= 63) s += 50;
            lowerCats.forEach(c => s += (p.scores[c] !== undefined ? p.scores[c] : simulate(c, false)));
            return s;
        });
        wins[simScores.indexOf(Math.max(...simScores))]++;
    }
    const bar = document.getElementById('probBar'); bar.innerHTML = "";
    players.forEach((p, i) => {
        const pct = (wins[i] / iter) * 100;
        const div = document.createElement('div'); div.className = "prob-seg";
        div.style.width = pct + "%"; div.style.backgroundColor = p.color;
        div.innerText = pct > 12 ? Math.round(pct) + "%" : "";
        bar.appendChild(div);
    });
}

function simulate(cat, isUpper) {
    const r = Math.random();
    if (isUpper) {
        const val = upperCats.indexOf(cat) + 1;
        if (val >= 4 && r > 0.75) return val * 4;
        return r > 0.4 ? val * 3 : 0;
    }
    switch(cat) {
        case "Yatzy": return r < 0.05 ? 50 : 0; case "Liten stege": return r < 0.6 ? 15 : 0; case "Stor stege": return r < 0.5 ? 20 : 0;
        case "K친k": return r < 0.4 ? 24 : 0; case "Tv친 par": return r < 0.8 ? 16 : 0; case "Chans": return 22; default: return 12;
    }
}
</script>
</body>
</html>
