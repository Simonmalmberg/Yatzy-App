<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Statzy - Elite Yatzy</title>
    <style>
        :root { 
            --bg: #0d0d0d; --card: #1c1c1e; --accent: #00d1ff; --text: #f2f2f7; --win: #34c759; --error: #ff3b30;
            --padd: 8px; --fs-base: 14px; --sb-h: 22px; --row-h: 38px; --prob-h: 22px;
        }

        body.zoom-normal { --padd: 8px; --fs-base: 14px; --sb-h: 22px; --row-h: 38px; }
        body.zoom-compact { --padd: 4px; --fs-base: 12px; --sb-h: 20px; --row-h: 32px; }
        body.zoom-tiny { --padd: 1px; --fs-base: 11px; --sb-h: 18px; --row-h: 28px; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 2px 2px 2px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; font-size: var(--fs-base); }
        
        /* Setup */
        #setup { text-align: center; padding-top: 30px; }
        .player-row { display: flex; align-items: center; justify-content: center; gap: 5px; margin: 10px 0; }
        input[type="text"] { background: #1c1c1e; border: 2px solid #333; color: white; padding: 12px; border-radius: 10px; width: 60%; font-size: 16px; outline: none; }
        .remove-btn { background: #451010; color: #ff3b30; border: 1px solid #631414; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 11px; }
        .btn-main { background: var(--accent); border: none; padding: 18px 30px; border-radius: 16px; font-weight: 800; cursor: pointer; color: #000; width: 85%; max-width: 320px; font-size: 1.1em; margin-top: 20px; }

        /* Game UI */
        header { position: sticky; top: 0; background: var(--bg); padding: 5px; z-index: 100; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #222; }
        .prob-bar { flex-grow: 1; display: flex; height: var(--prob-h); background: #111; border-radius: 6px; overflow: hidden; border: 1px solid #333; }
        .prob-seg { transition: width 0.8s cubic-bezier(0.2, 1, 0.3, 1); text-align: center; color: #000; font-size: 11px; line-height: var(--prob-h); font-weight: 900; }
        
        /* Tables & Sticky Labels */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 300px; }
        td, th { padding: var(--padd) 2px; border-bottom: 1px solid #222; text-align: center; height: var(--row-h); position: relative; }
        
        /* STICKY COLUMN FIX */
        td:first-child, th:first-child { 
            position: sticky; left: 0; z-index: 10; background: var(--bg); 
            text-align: left; width: 90px; font-weight: 700; color: #999; 
            padding-left: 10px; border-right: 2px solid #222;
        }

        .score-box { background: #1a1a1c; border-radius: 6px; min-height: var(--sb-h); border: 1px solid #333; font-weight: 800; color: var(--accent); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .last-changed-box { border: 2px solid #fff !important; animation: pulseBorder 2s infinite; z-index: 5; }
        
        /* Turn Indicator */
        .active-turn-head { color: #fff !important; text-decoration: underline; text-underline-offset: 4px; animation: pulseTurn 1.5s infinite; }
        @keyframes pulseTurn { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes pulseBorder { 50% { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); } }

        /* TV Mode Splits */
        body.mode-tv #score-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 5px; }

        /* Modals */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; backdrop-filter: blur(10px); }
        .modal { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #1c1c1e; z-index: 1001; border-radius: 24px 24px 0 0; padding: 20px; box-sizing: border-box; border-top: 1px solid #444; }
        
        .modal-cat-name { font-size: 1.4em; font-weight: 900; color: var(--accent); text-transform: uppercase; text-align: center; }
        .modal-player-name { font-size: 1em; color: #888; text-align: center; margin-bottom: 20px; }

        /* Input Grids */
        .dice-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .dice-btn { background: #2c2c2e; border: 2px solid #3a3a3c; border-radius: 12px; padding: 15px 5px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .dice-btn span { font-size: 20px; color: #fff; }
        .dice-btn small { font-size: 14px; font-weight: 900; color: var(--accent); }
        .dice-btn.active { border-color: var(--accent); background: #1a3a4a; }
        .dice-btn.zero { background: #451010; border-color: #631414; }

        /* Ladder Buttons */
        .ladder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ladder-btn { border-radius: 16px; padding: 30px 10px; text-align: center; font-weight: 900; font-size: 1.2em; border: none; }
        .l-win { background: var(--win); color: #000; }
        .l-fail { background: var(--error); color: #fff; }

        /* TV Popups */
        #tv-emoji { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 120px; z-index: 2000; pointer-events: none; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #tv-emoji.show { transform: translate(-50%, -50%) scale(1); }

        .clear-btn { background: none; color: #555; border: none; margin-top: 20px; width: 100%; text-decoration: underline; font-size: 14px; }

        @media (orientation: landscape) {
            .modal { overflow-y: auto; height: 100%; border-radius: 0; padding: 10px 40px; }
            .dice-grid { grid-template-columns: repeat(6, 1fr); }
            .ladder-btn { padding: 15px; }
        }
    </style>
</head>
<body>

<div id="tv-emoji"></div>

<div id="setup">
    <h1 style="font-size: 4em; margin: 0; color: var(--accent); letter-spacing: -3px; font-weight: 900;">Statzy</h1>
    <div id="player-list"></div>
    <button style="background:none; border:1px solid #333; color:#777; padding:10px; border-radius:10px; font-size:12px; margin-top:15px" onclick="addPlayerField('')">+ L√ÑGG TILL SPELARE</button>
    <br>
    <button class="btn-main" onclick="startGame()">STARTA MATCH</button>
</div>

<div id="game" style="display:none;">
    <header>
        <button style="background:#222; border:none; color:#aaa; padding:8px 12px; border-radius:8px;" onclick="openSettings()">‚öôÔ∏è</button>
        <div class="prob-bar" id="probBar"></div>
    </header>
    
    <div id="score-container">
        <div class="table-wrap"><table id="tableUpper"></table></div>
        <div class="table-wrap"><table id="tableLower"></table></div>
    </div>

    <div class="game-footer" id="mainFooter" style="text-align:center; padding:20px; display:none;">
        <button class="btn-main" onclick="nextRound()" style="background:var(--win)">N√ÑSTA RUNDA</button>
    </div>
</div>

<div class="overlay" id="overlaySettings" onclick="closeSettings()"></div>
<div class="modal" id="modalSettings">
    <h2 style="text-align:center">Inst√§llningar</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
        <button class="quick-btn" onclick="setZoom('zoom-normal')">STD</button>
        <button class="quick-btn" onclick="setZoom('zoom-compact')">KOMP</button>
        <button class="quick-btn" onclick="setZoom('zoom-tiny')">MINI</button>
    </div>
    <button class="btn-main" style="width:100%; background:var(--error); color:#fff;" onclick="nextRound()">AVSLUTA MATCH (TVINGA)</button>
    <button class="btn-main" style="width:100%" onclick="closeSettings()">KLAR</button>
</div>

<div class="overlay" id="overlayInput" onclick="closeModal()"></div>
<div class="modal" id="modalInput">
    <div id="modalHeader"></div>
    
    <div id="dice-input" style="display:none;">
        <div class="dice-grid" id="diceGrid"></div>
    </div>

    <div id="ladder-input" style="display:none;">
        <div class="ladder-grid">
            <button class="ladder-btn l-win" onclick="handleLadder(true)">LYCKAD ‚úÖ</button>
            <button class="ladder-btn l-fail" onclick="handleLadder(false)">MISSAD ‚ùå</button>
        </div>
    </div>

    <div id="numeric-input" style="display:none;">
        <div id="num-display" style="background:#000; color:var(--accent); font-size:40px; text-align:center; padding:10px; border-radius:12px; margin-bottom:15px; border:1px solid #333">-</div>
        <div class="dice-grid">
            <div class="quick-btn" onclick="pressNum(1)">1</div><div class="quick-btn" onclick="pressNum(2)">2</div><div class="quick-btn" onclick="pressNum(3)">3</div>
            <div class="quick-btn" onclick="pressNum(4)">4</div><div class="quick-btn" onclick="pressNum(5)">5</div><div class="quick-btn" onclick="pressNum(6)">6</div>
            <div class="quick-btn" onclick="pressNum(7)">7</div><div class="quick-btn" onclick="pressNum(8)">8</div><div class="quick-btn" onclick="pressNum(9)">9</div>
            <div class="quick-btn" style="background:#444" onclick="pressNum('C')">C</div><div class="quick-btn" onclick="pressNum(0)">0</div>
            <div class="quick-btn" style="background:var(--win); color:#000" onclick="confirmNumeric()">OK</div>
        </div>
    </div>

    <button class="clear-btn" onclick="setScoreAndClose(null)">Rensa ruta</button>
</div>

<script>
let players = [];
let activePIdx = null, activeCat = null, currentNumInput = "";
let lastChangedCell = { pIdx: null, cat: null };
let currentPlayerTurn = 0;

const upperCats = ["Ettor", "Tv√•or", "Treor", "Fyror", "Femmor", "Sexor"];
const lowerCats = ["Ett par", "Tv√• par", "Triss", "Fyrtal", "Liten stege", "Stor stege", "K√•k", "Chans", "Yatzy"];
const diceIcons = ["", "‚öÄ", "‚öÅ", "‚öÇ", "‚öÉ", "‚öÑ", "‚öÖ"];

window.onload = () => {
    const savedNames = localStorage.getItem('statzy_names');
    const savedScores = localStorage.getItem('statzy_scores');
    if (savedNames) {
        JSON.parse(savedNames).forEach(n => addPlayerField(n));
        if (savedScores) {
            players = JSON.parse(savedScores);
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            renderBoard();
        }
    } else {
        addPlayerField('Spelare 1'); addPlayerField('Spelare 2');
    }
};

function addPlayerField(name) {
    const div = document.createElement('div');
    div.className = 'player-row';
    div.innerHTML = `<input type="text" placeholder="Namn" value="${name}">
        <button class="remove-btn" onclick="this.parentElement.remove()">X</button>`;
    document.getElementById('player-list').appendChild(div);
}

function startGame() {
    const inputs = document.querySelectorAll('#player-list input');
    players = Array.from(inputs).map((i, idx) => ({
        name: i.value || `S${idx+1}`,
        scores: {},
        color: ["#34c759", "#00d1ff", "#ffcc00", "#ff3b30", "#af52de", "#ff9500"][idx % 6]
    }));
    localStorage.setItem('statzy_names', JSON.stringify(players.map(p => p.name)));
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    renderBoard();
}

function renderBoard() {
    const renderTable = (cats, isUpper) => {
        let h = `<thead><tr><th></th>${players.map((p, i) => 
            `<th style="color:${p.color}" class="${currentPlayerTurn === i ? 'active-turn-head' : ''}">${p.name}</th>`).join('')}</tr></thead><tbody>`;
        
        cats.forEach(cat => {
            h += `<tr><td>${cat}</td>${players.map((p, i) => {
                let val = p.scores[cat];
                let display = val === undefined ? "" : (val === 0 ? "/" : val);
                let isLast = lastChangedCell.pIdx === i && lastChangedCell.cat === cat;
                return `<td><div class="score-box ${isLast ? 'last-changed-box' : ''}" onclick="openInput(${i}, '${cat}')">${display}</div></td>`;
            }).join('')}</tr>`;
        });

        if(isUpper) {
            h += `<tr style="background:#111"><td>¬± Par</td>${players.map((p, i) => {
                const v = calculateValues(i);
                let diff = v.diff === 0 ? "par" : (v.diff > 0 ? "+" + v.diff : v.diff);
                return `<td style="color:${v.diff < 0 ? '#ff3b30' : '#34c759'}">${diff}</td>`;
            }).join('')}</tr>`;
            h += `<tr style="background:#000; border-top:1px solid #333"><td>Bonus</td>${players.map((p, i) => `<td>${calculateValues(i).bonus}</td>`).join('')}</tr>`;
        } else {
            h += `<tr style="background:#000; color:var(--accent); font-weight:900"><td>TOTALT</td>${players.map((p, i) => `<td>${calculateValues(i).total}</td>`).join('')}</tr>`;
        }
        return h + "</tbody>";
    };

    document.getElementById('tableUpper').innerHTML = renderTable(upperCats, true);
    document.getElementById('tableLower').innerHTML = renderTable(lowerCats, false);
    updatePrognosis();
    checkGameOver();
}

function openInput(pIdx, cat) {
    // 1. Varning om man skippar tur
    if (pIdx !== currentPlayerTurn) {
        if (!confirm(`Det √§r egentligen ${players[currentPlayerTurn].name}s tur. Vill du √§ndra f√∂r ${players[pIdx].name} √§nd√•?`)) return;
    }

    // 2. Varning om √∂verskrivning
    if (players[pIdx].scores[cat] !== undefined) {
        if (!confirm(`Det finns redan po√§ng h√§r (${players[pIdx].scores[cat]}). Vill du √§ndra?`)) return;
    }

    activePIdx = pIdx; activeCat = cat;
    document.getElementById('modalHeader').innerHTML = `<div class="modal-cat-name">${cat}</div><div class="modal-player-name">${players[pIdx].name}</div>`;
    
    document.getElementById('overlayInput').style.display = 'block';
    document.getElementById('modalInput').style.display = 'block';

    const diceInp = document.getElementById('dice-input');
    const laddInp = document.getElementById('ladder-input');
    const numInp = document.getElementById('numeric-input');
    
    diceInp.style.display = 'none'; laddInp.style.display = 'none'; numInp.style.display = 'none';

    if (upperCats.includes(cat)) {
        diceInp.style.display = 'block';
        renderDiceGrid(upperCats.indexOf(cat) + 1, 5);
    } else if (["Ett par", "Triss", "Fyrtal"].includes(cat)) {
        diceInp.style.display = 'block';
        renderSpecialDice(cat);
    } else if (cat.includes("stege") || cat === "Yatzy") {
        laddInp.style.display = 'block';
    } else {
        numInp.style.display = 'block';
        currentNumInput = "";
        document.getElementById('num-display').innerText = "-";
    }
}

function renderDiceGrid(dieVal, max) {
    const grid = document.getElementById('diceGrid');
    grid.innerHTML = `<div class="dice-btn zero" onclick="setScoreAndClose(0)"><span>‚ùå</span><small>0</small></div>`;
    for (let i = 1; i <= max; i++) {
        let diceStr = ""; for(let d=0; d<i; d++) diceStr += diceIcons[dieVal];
        grid.innerHTML += `<div class="dice-btn" onclick="setScoreAndClose(${i * dieVal})"><span>${diceStr}</span><small>${i * dieVal}</small></div>`;
    }
}

function renderSpecialDice(cat) {
    const grid = document.getElementById('diceGrid');
    grid.innerHTML = `<div class="dice-btn zero" onclick="setScoreAndClose(0)"><span>‚ùå</span><small>0</small></div>`;
    let count = cat === "Ett par" ? 2 : (cat === "Triss" ? 3 : 4);
    for (let v = 1; v <= 6; v++) {
        let diceStr = ""; for(let d=0; d<count; d++) diceStr += diceIcons[v];
        grid.innerHTML += `<div class="dice-btn" onclick="setScoreAndClose(${v * count})"><span>${diceStr}</span><small>${v * count}</small></div>`;
    }
}

function handleLadder(success) {
    let score = 0;
    if (success) {
        if (activeCat === "Liten stege") score = 15;
        else if (activeCat === "Stor stege") score = 20;
        else if (activeCat === "Yatzy") score = 50;
    }
    setScoreAndClose(score);
}

function pressNum(v) {
    if (v === 'C') currentNumInput = ""; 
    else if (currentNumInput.length < 2) currentNumInput += v;
    document.getElementById('num-display').innerText = currentNumInput || "-";
    
    // Auto-log
    if (currentNumInput.length === 1 && parseInt(v) >= 5) confirmNumeric();
    else if (currentNumInput.length === 2) confirmNumeric();
}

function confirmNumeric() {
    const val = parseInt(currentNumInput);
    if (isNaN(val)) return;
    setScoreAndClose(val);
}

function setScoreAndClose(score) {
    if (score === null) {
        delete players[activePIdx].scores[activeCat];
    } else {
        players[activePIdx].scores[activeCat] = score;
        lastChangedCell = { pIdx: activePIdx, cat: activeCat };
        triggerEmoji(score, activeCat);
        // Flytta turen till n√§sta spelare
        currentPlayerTurn = (activePIdx + 1) % players.length;
    }
    saveScores();
    closeModal();
    renderBoard();
}

function triggerEmoji(score, cat) {
    const el = document.getElementById('tv-emoji');
    let emo = "üëç";
    if (score === 0) emo = "üíÄ";
    else if (score === 50) emo = "üî•üëëüî•";
    else if (upperCats.includes(cat)) {
        const val = upperCats.indexOf(cat) + 1;
        if (score === val * 5) emo = "ü§©";
        if (score === val * 4) emo = "üî•";
    }
    el.innerText = emo;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 1500);
}

function calculateValues(pIdx) {
    let sum = 0, diff = 0;
    upperCats.forEach((cat, idx) => {
        if (players[pIdx].scores[cat] !== undefined) {
            sum += players[pIdx].scores[cat];
            diff += (players[pIdx].scores[cat] - (idx + 1) * 3);
        }
    });
    const bonus = sum >= 63 ? 50 : 0;
    const total = sum + bonus + lowerCats.reduce((a,c) => a + (players[pIdx].scores[c] || 0), 0);
    return { sum, bonus, total, diff };
}

function updatePrognosis() {
    // Simpel simulering f√∂r stapeln
    const bar = document.getElementById('probBar');
    bar.innerHTML = "";
    let totals = players.map((p, i) => calculateValues(i).total + (15 - Object.keys(p.scores).length) * 10);
    let sumTotal = totals.reduce((a, b) => a + b, 0);
    players.forEach((p, i) => {
        let pct = (totals[i] / sumTotal) * 100;
        bar.innerHTML += `<div class="prob-seg" style="width:${pct}%; background:${p.color}">${Math.round(pct)}%</div>`;
    });
}

function checkGameOver() {
    const isDone = players.every(p => Object.keys(p.scores).length === 15);
    document.getElementById('mainFooter').style.display = isDone ? 'block' : 'none';
}

function closeModal() { 
    document.getElementById('overlayInput').style.display = 'none'; 
    document.getElementById('modalInput').style.display = 'none'; 
}
function openSettings() { document.getElementById('overlaySettings').style.display = 'block'; document.getElementById('modalSettings').style.display = 'block'; }
function closeSettings() { document.getElementById('overlaySettings').style.display = 'none'; document.getElementById('modalSettings').style.display = 'none'; }
function saveScores() { localStorage.setItem('statzy_scores', JSON.stringify(players)); }
function nextRound() { if(confirm("Starta ny runda?")) { localStorage.removeItem('statzy_scores'); location.reload(); } }
function setZoom(z) { document.body.className = z; }
</script>

</body>
</html>
